<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="styles.css">
<link rel="icon" type="image/x-icon" href="favicon.png">
</head>
<body>
<div class="container">
<div class="column" id="column1">
<div class="logo">
<img src="biscuit_logo.svg">
<label class="version">0.11.0</label>
</div>
<ul id="menu-top-level">
<li id="menu-top-level-item"><a href="index.html">Home</a></li>
<li id="menu-top-level-item"><a href="installation.html">Installation</a></li>
<li id="menu-top-level-item"><a href="manual.html">Manual</a></li>
<li id="menu-top-level-item"><a href="modules.html">Modules</a></li>
<li id="menu-top-level-item"><a href="examples.html">Examples</a></li>
</ul>
</div>
<div class="column" id="column2">
<h1 id="Simple-Allocator">Simple Allocator</h1>
<p>Compile using <code>blc my-file-name.bl</code> and run <code>./out</code>.</p>

<pre><code>MyAllocator :: <span class="syntax-keyword">struct</span> <span class="syntax-directive">#base</span> Allocator <span class="syntax-keyword">{</span>
	buffer: []u8;
	used_bytes: usize;
<span class="syntax-keyword">}</span>

allocator_make :: <span class="syntax-keyword">fn</span> (buffer: []u8) MyAllocator <span class="syntax-keyword">{</span>
	<span class="syntax-keyword">return</span> MyAllocator.<span class="syntax-keyword">{</span>
		base = Allocator.<span class="syntax-keyword">{</span> <span class="syntax-keyword">auto</span> &my_allocator_handler <span class="syntax-keyword">}</span>,
		buffer = buffer,
		used_bytes = 0,
	<span class="syntax-keyword">}</span>;
<span class="syntax-keyword">}</span>

my_allocator_handler :: <span class="syntax-keyword">fn</span> (
	allocator: *MyAllocator,
	<span class="syntax-comment">// Operation specify whether we do allocation or free.</span>
	operation: AllocOp,
	<span class="syntax-comment">// Pointer to the previously allocated memory. </span>
	_: *u8,
	<span class="syntax-comment">// Count of bytes to be allocated.</span>
	size: usize,
	<span class="syntax-comment">// Allocation allignment.</span>
	alignment: usize,
	<span class="syntax-comment">// Source file where allocator was called.</span>
	file: string_view,
	<span class="syntax-comment">// Line in source file where allocator was called.</span>
	line: s32) (mem: *u8, err: Error)
<span class="syntax-keyword">{</span>
	<span class="syntax-keyword">using</span> AllocOp;
	<span class="syntax-keyword">switch</span> operation <span class="syntax-keyword">{</span>
		ALLOCATE   <span class="syntax-keyword">{</span>
			print("Allocate %B called from %:%.", size, file, line);
			<span class="syntax-keyword">return</span> allocate(allocator, size, alignment);
		<span class="syntax-keyword">}</span>
		REALLOCATE <span class="syntax-keyword">{</span>
			<span class="syntax-comment">// To properly support reallocation, we have to store additional metadata</span>
			<span class="syntax-comment">// containing the size of the previous allocated memory associated with input</span>
			<span class="syntax-comment">// ptr pointer.</span>
			<span class="syntax-comment">// This is not implemented in this example to keep things simple.</span>
			<span class="syntax-keyword">panic</span>("Rellocation is not supported.");
		<span class="syntax-keyword">}</span>
		FREE <span class="syntax-keyword">{</span>
			print("Free called from %:%.", file, line);
		<span class="syntax-keyword">}</span>
		RESET, RELEASE <span class="syntax-keyword">{</span>
			<span class="syntax-keyword">panic</span>("Unsupported operation: %.", operation);
		<span class="syntax-keyword">}</span>

		<span class="syntax-keyword">default</span> <span class="syntax-keyword">{</span> <span class="syntax-keyword">panic</span>("Unknown operation."); <span class="syntax-keyword">}</span>
	<span class="syntax-keyword">}</span>
	<span class="syntax-keyword">return</span> null, OK;
<span class="syntax-keyword">}</span>

allocate :: <span class="syntax-keyword">fn</span> (allocator: *MyAllocator, size: usize, alignment: usize) (mem: *u8, err: Error) <span class="syntax-keyword">{</span>
	<span class="syntax-comment">// Alignment mask.</span>
	mask :: ~(alignment - 1);
	<span class="syntax-comment">// We need some additional space to properly align the allocation.</span>
	adjusted_size :: size + alignment - 1;
	<span class="syntax-comment">// Calculate total size needed.</span>
	needed_size :: allocator.used_bytes + adjusted_size;
	<span class="syntax-comment">// Check if there is space enough in out buffer.</span>
	<span class="syntax-keyword">if</span> needed_size &gt; <span class="syntax-keyword">auto</span> allocator.buffer.len <span class="syntax-keyword">{</span>
		<span class="syntax-keyword">return</span> null, error("The buffer is full! The buffer size is %B and required size is %B.", allocator.buffer.len, needed_size);
	<span class="syntax-keyword">}</span>
	<span class="syntax-comment">// Get free memory pointer.</span>
	mem := &allocator.buffer[<span class="syntax-keyword">auto</span> allocator.used_bytes];
	<span class="syntax-comment">// Adjust used size.</span>
	allocator.used_bytes += adjusted_size;
	<span class="syntax-comment">// Align memory pointer.</span>
	mem = <span class="syntax-keyword">auto</span> ((<span class="syntax-keyword">cast</span>(usize) mem) + alignment - 1 & mask);
	<span class="syntax-keyword">return</span> mem, OK;
<span class="syntax-keyword">}</span>

User :: <span class="syntax-keyword">struct</span> <span class="syntax-keyword">{</span>
	name: string_view;
	age: s32;
<span class="syntax-keyword">}</span>

main :: <span class="syntax-keyword">fn</span> () s32 <span class="syntax-keyword">{</span>
	buffer: [2048]u8;
	allocator :: allocator_make(buffer);

	user :: new(User, true, &allocator);
	user.name = "Martin.";
	user.age = 32;

	print("User = %\n", @user);

	free(<span class="syntax-keyword">auto</span> user, &allocator);
	<span class="syntax-keyword">return</span> 0;
<span class="syntax-keyword">}</span>

</code></pre>
</div>
<div class="column" id="column3">
<ul id="menu-top-level">
<li id="menu-top-level-item"><a href="#Simple-Allocator">Simple Allocator</a></li>
</ul>
</div>
</div>
</body>
</html>
