<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="styles.css">
<link rel="icon" type="image/x-icon" href="favicon.png">
</head>
<body>
<div class="container">
<div class="column" id="column1">
<div class="logo">
<img src="biscuit_logo.svg">
<label class="version">master</label>
</div>
<ul id="menu-top-level">
<li id="menu-top-level-item"><a href="index.html">Home</a></li>
<li id="menu-top-level-item"><a href="installation.html">Installation</a></li>
<li id="menu-top-level-item"><a href="manual.html">Manual</a></li>
<li id="menu-top-level-item"><a href="modules.html">Modules</a></li>
<li id="menu-top-level-item"><a href="examples.html">Examples</a></li>
</ul>
</div>
<div class="column" id="column2">
<h1 id="Data-Streams">Data Streams</h1>
<p>Compile using <code>blc my-file-name.bl</code> and run <code>./out</code>.</p>

<pre><code><span class="syntax-directive">#import</span> "std/io"

<span class="syntax-comment">// Custom stream implementation based on std.Stream.</span>
MyStream :: <span class="syntax-keyword">struct</span> <span class="syntax-directive">#base</span> std.Stream <span class="syntax-keyword">{</span>
	<span class="syntax-comment">// Preallocated static buffer.</span>
	buffer: [64]u8;
	<span class="syntax-comment">// Current position in the buffer array.</span>
	position: s64;
<span class="syntax-keyword">}</span>

<span class="syntax-comment">// Virtual table of the stream setting up stream API functions. Our implementation</span>
<span class="syntax-comment">// does not support seeking, so the seek function is null.</span>
MY_STRAM_VTABLE :: std.StreamVTable.<span class="syntax-keyword">{</span>
	read  = <span class="syntax-keyword">auto</span> &my_read,
	write = <span class="syntax-keyword">auto</span> &my_write
<span class="syntax-keyword">}</span>;

<span class="syntax-comment">// Actual read function implementation.</span>
my_read :: <span class="syntax-keyword">fn</span> (stream: *MyStream, dest: *u8, bytes_to_read: s64) (s64, Error) <span class="syntax-keyword">{</span>
	<span class="syntax-keyword">using</span> std;
	size := min(stream.position, bytes_to_read);
	stream.position -= size;
	<span class="syntax-keyword">if</span> stream.position &lt; 0 <span class="syntax-keyword">{</span>
		size -= stream.position;
		stream.position = 0;
	<span class="syntax-keyword">}</span>
	<span class="syntax-keyword">if</span> size &gt; 0 <span class="syntax-keyword">{</span>
		memcpy(dest, &stream.buffer[stream.position], <span class="syntax-keyword">auto</span> size);
	<span class="syntax-keyword">}</span>
	<span class="syntax-keyword">return</span> size, OK;
<span class="syntax-keyword">}</span>

<span class="syntax-comment">// Actual write function implementation.</span>
my_write :: <span class="syntax-keyword">fn</span> (stream: *MyStream, src: *u8, bytes_to_write: s64) (s64, Error) <span class="syntax-keyword">{</span>
	size :: std.min(stream.buffer.len - stream.position, bytes_to_write);
	<span class="syntax-keyword">if</span> size &gt; 0 <span class="syntax-keyword">{</span>
		<span class="syntax-comment">// size may be zero even in case the buffer is full.</span>
		memcpy(&stream.buffer[stream.position], src, <span class="syntax-keyword">auto</span> size);
		stream.position += size;
	<span class="syntax-keyword">}</span>
	<span class="syntax-keyword">return</span> size, OK;
<span class="syntax-keyword">}</span>

init_stream :: <span class="syntax-keyword">fn</span> (stream: *MyStream) <span class="syntax-keyword">{</span>
	stream.vtable = &MY_STRAM_VTABLE;
	stream.position = 0;
<span class="syntax-keyword">}</span>

main :: <span class="syntax-keyword">fn</span> () s32 <span class="syntax-keyword">{</span>
	<span class="syntax-keyword">using</span> std;

	stream: MyStream <span class="syntax-directive">#noinit</span>;
	init_stream(&stream);

	<span class="syntax-comment">// Use of the IO API.</span>
	write_string(&stream, "Hello");
	write_string(&stream, "World");

	str := str_new();
	<span class="syntax-keyword">defer</span> str_delete(&str);

	read_string(&stream, &str);

	print("%\n", str);
	<span class="syntax-keyword">return</span> 0;
<span class="syntax-keyword">}</span>

</code></pre>
</div>
<div class="column" id="column3">
<ul id="menu-top-level">
<li id="menu-top-level-item"><a href="#Data-Streams">Data Streams</a></li>
</ul>
</div>
</div>
</body>
</html>
